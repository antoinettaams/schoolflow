// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  clerkUserId  String   @unique
  email        String   @unique
  role         UserRole
  firstName    String
  lastName     String
  phone        String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relations
  events       Event[]
  parent       Parent?
  student      Student?
  teacher      Teacher?
  
  // Relations de création
  createdById  String?
  createdBy    User?    @relation("UserCreation", fields: [createdById], references: [id])
  createdUsers User[]   @relation("UserCreation")
  
  // Rapports d'activité (créés par l'utilisateur)
  bilan       Bilan[]
  
  // Autres relations
  reports              Report[]
  inscriptionsCreees   Inscription[] @relation("UserInscriptions")
  fraisConfigurations  FraisConfiguration[]
  paiementsCrees       Paiement[]
  dossier              Dossier[]
  modeleCarte          ModeleCarte[]
  impressions          ImpressionCarte[]
  historiques          HistoriqueCarte[]

  @@map("users")
}

model Student {
  id            String   @id @default(cuid())
  userId        String   @unique
  studentNumber String   @unique
  filiereId     Int?
  vagueId       String?
  createdAt     DateTime @default(now())
  vagueNumber   Int?
  
  // Relations
  filiere       Filiere? @relation(fields: [filiereId], references: [id])
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  vague         Vague?   @relation("VagueStudents", fields: [vagueId], references: [id])
  grades        Grade[]
  attendance    Attendance[]
  cartes        CarteEtudiante[]
  facture       Facture[]
  operation     Operation[]

  @@map("students")
}

model Teacher {
  id                   String                @id @default(cuid())
  userId               String                @unique
  matiere              String
  createdAt            DateTime              @default(now())
  
  // Relations
  enseignements        Enseignement[]
  planningAssignations PlanningAssignation[]
  homeworks            Homework[]
  gradeFormulas        GradeFormula[]
  grades               Grade[]
  user                 User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  attendance           Attendance[]
  report               Report[]

  @@map("teachers")
}

model Parent {
  id         String   @id @default(cuid())
  userId     String   @unique
  enfantName String
  filiere    String
  relation   String
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("parents")
}

model Filiere {
  id                   Int                   @id @default(autoincrement())
  nom                  String
  description          String?
  dureeFormation       String
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  
  // Relations
  modules              Module[]
  planningAssignations PlanningAssignation[]
  semestres            Semestre[]
  students             Student[]
  vaguesPivot          VagueFiliere[]
  homeworks            Homework[]
  grades               Grade[]
  inscriptions         Inscription[]
  fraisFormations      FraisFormation[]
  attendance           Attendance[]
  cartesEtudiantes     CarteEtudiante[]

  @@map("filieres")
}

model Semestre {
  id          Int      @id @default(autoincrement())
  nom         String
  description String?
  dateDebut   DateTime
  dateFin     DateTime
  filiereId   Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  modules     Module[]
  filiere     Filiere  @relation(fields: [filiereId], references: [id], onDelete: Cascade)
  grade       Grade[]

  @@map("semestres")
}

model Module {
  id                   Int                   @id @default(autoincrement())
  nom                  String
  coefficient          Int
  typeModule           TypeModule
  description          String?
  filiereId            Int
  semestreId           Int?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  
  // Relations
  enseignements        Enseignement[]
  filiere              Filiere               @relation(fields: [filiereId], references: [id], onDelete: Cascade)
  semestre             Semestre?             @relation(fields: [semestreId], references: [id])
  planningAssignations PlanningAssignation[]
  homeworks            Homework[]
  grades               Grade[]
  report               Report[]
  attendance           Attendance[]

  @@map("modules")
}

model Enseignement {
  id           Int      @id @default(autoincrement())
  professeurId String
  moduleId     Int
  jour         String
  heureDebut   String
  heureFin     String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  salleId      String?
  
  // Relations
  module       Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  teacher      Teacher  @relation(fields: [professeurId], references: [id], onDelete: Cascade)
  salle        Salle?   @relation(fields: [salleId], references: [id])

  @@map("enseignements")
}

model Vague {
  id                   String                @id @default(cuid())
  nom                  String                @unique
  description          String?
  semestres            String
  dateDebut            DateTime
  dateFin              DateTime
  isActive             Boolean               @default(true)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  
  // Relations
  planningAssignations PlanningAssignation[]
  students             Student[]             @relation("VagueStudents")
  filieresPivot        VagueFiliere[]
  homeworks            Homework[]
  grades               Grade[]
  report               Report[]
  inscriptions         Inscription[]
  fraisFormations      FraisFormation[]
  attendance           Attendance[]
  cartesEtudiantes     CarteEtudiante[]
  bilans               Bilan[]               @relation("VagueBilan")

  @@map("vagues")
}

model VagueFiliere {
  vagueId   String
  filiereId Int
  
  // Relations
  filiere   Filiere @relation(fields: [filiereId], references: [id], onDelete: Cascade)
  vague     Vague   @relation(fields: [vagueId], references: [id], onDelete: Cascade)

  @@id([vagueId, filiereId])
  @@map("vague_filiere")
}

model PlanningAssignation {
  id             String   @id @default(cuid())
  vagueId        String
  filiereId      Int
  moduleId       Int
  teacherId      String
  scheduleSlots  Json
  schedulePeriod Json
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relations
  filiere        Filiere  @relation(fields: [filiereId], references: [id])
  module         Module   @relation(fields: [moduleId], references: [id])
  teacher        Teacher  @relation(fields: [teacherId], references: [id])
  vague          Vague    @relation(fields: [vagueId], references: [id])

  @@map("planning_assignations")
}

model Event {
  id          String   @id @default(cuid())
  title       String
  type        String
  location    String
  date        String
  day         String
  month       String
  time        String
  description String?
  badge       String   @default("Important")
  icon        String
  color       String
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  createdBy   User?    @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@map("events")
}

model Salle {
  id            String         @id @default(cuid())
  nom           String         @unique
  capacite      Int
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  // Relations
  enseignements Enseignement[]

  @@map("salles")
}

model Homework {
  id           String   @id @default(cuid())
  title        String
  exerciseType String
  pages        String?
  content      String?
  date         DateTime
  deadline     DateTime
  status       String   @default("actif")
  fileUrl      String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  teacherId    String
  filiereId    Int?
  vagueId      String?
  moduleId     Int?
  
  // Relations
  teacher      Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  filiere      Filiere? @relation(fields: [filiereId], references: [id])
  vague        Vague?   @relation(fields: [vagueId], references: [id])
  module       Module?  @relation(fields: [moduleId], references: [id])

  @@map("homeworks")
}

model Grade {
  id            String   @id @default(cuid())

  // Relations EXISTANTES
  studentId     String
  student       Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  moduleId      Int
  module        Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  filiereId     Int
  filiere       Filiere  @relation(fields: [filiereId], references: [id], onDelete: Cascade)

  vagueId       String
  vague         Vague    @relation(fields: [vagueId], references: [id], onDelete: Cascade)

  teacherId     String
  teacher       Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  // Notes EXISTANTES
  interrogation1 Float?
  interrogation2 Float?
  interrogation3 Float?
  devoir        Float?
  composition   Float?
  rang          Int?

  // Formule utilisée EXISTANTE
  formulaUsed   String?

  // AJOUTS POUR LE BILAN ACADEMIQUE
  semestreId    Int?
  semestre      Semestre? @relation(fields: [semestreId], references: [id])
  moyenneModule  Float?
  appreciation  String?
  estValide     Boolean  @default(false)
  session       String   @default("principale")

  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([studentId, moduleId, filiereId, vagueId, semestreId, session])
  @@map("grades")
}

model GradeFormula {
  id          String   @id @default(cuid())
  name        String
  formula     String
  description String?
  teacherId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  teacher     Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@map("grade_formulas")
}

model Attendance {
  id          String   @id @default(cuid())

  // Relations
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  teacherId   String
  teacher     Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  filiereId   Int?
  filiere     Filiere? @relation(fields: [filiereId], references: [id])

  vagueId     String?
  vague       Vague?   @relation(fields: [vagueId], references: [id])

  moduleId    Int?
  module      Module?  @relation(fields: [moduleId], references: [id])

  // Données de présence
  date        DateTime
  courseTime  String
  subject     String
  status      String
  justified   Boolean  @default(false)
  reason      String?
  semester    String

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([studentId, date, courseTime, semester])
  @@map("attendances")
}

// RAPPORT DE COURS
model Report {
  id                String   @id @default(cuid())
  moduleId          Int
  teacherId         String
  vagueId           String
  date              DateTime
  chapitre          String
  objectif          String
  dureePlanifiee    String
  dureeReelle       String
  progression       String
  difficulte        String?
  evaluation        Float
  commentaireProf   String?
  commentaireCenseur String?
  createdBy         String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  module            Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  teacher           Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  vague             Vague    @relation(fields: [vagueId], references: [id], onDelete: Cascade)
  user              User     @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@map("reports")
}

model Inscription {
  id              String             @id @default(cuid())
  nom             String
  prenom          String
  email           String             @unique
  telephone       String
  dateNaissance   DateTime?
  dateInscription DateTime           @default(now())
  statut          StatutInscription  @default(EN_ATTENTE)
  fraisInscription Int
  fraisPayes      Int               @default(0)
  datePaiement    DateTime?
  filiereId       Int?
  vagueId         String?
  createdById     String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  filiere         Filiere?          @relation(fields: [filiereId], references: [id])
  vague           Vague?            @relation(fields: [vagueId], references: [id])
  createdBy       User              @relation("UserInscriptions", fields: [createdById], references: [id])
  paiements       Paiement[]
  dossier         Dossier[]
  operation       Operation[]

  @@map("inscriptions")
}

model Paiement {
  id              String   @id @default(cuid())
  inscriptionId   String
  montant         Int
  datePaiement    DateTime @default(now())
  modePaiement    String
  reference       String?
  createdById     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  createdBy       User?    @relation(fields: [createdById], references: [id])
  inscription     Inscription @relation(fields: [inscriptionId], references: [id], onDelete: Cascade)
  facture         Facture[]
  operation       Operation[]

  @@map("paiements")
}

model FraisFormation {
  id              String         @id @default(cuid())
  vagueId         String
  filiereId       Int
  fraisScolarite  Int
  servicesInclus  Json
  statut          FraisStatut    @default(ACTIF)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  vague           Vague          @relation(fields: [vagueId], references: [id], onDelete: Cascade)
  filiere         Filiere        @relation(fields: [filiereId], references: [id], onDelete: Cascade)

  @@unique([vagueId, filiereId])
  @@map("frais_formations")
}

model FraisConfiguration {
  id          String     @id @default(cuid())
  type        TypeFrais  @unique
  montant     Int
  description String?
  createdById String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  createdBy   User       @relation(fields: [createdById], references: [id])

  @@map("frais_configurations")
}

model Dossier {
  id              String         @id @default(cuid())
  inscriptionId   String         @unique
  statut          StatutDossier  @default(EN_ATTENTE)
  dateCreation    DateTime       @default(now())
  dateMaj         DateTime       @updatedAt
  photoIdentite   String?
  acteNaissance   String?
  relevesNotes    String?
  autresDocuments Json?
  createdBy       String

  // Relations
  inscription     Inscription    @relation(fields: [inscriptionId], references: [id], onDelete: Cascade)
  user            User           @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@map("dossiers")
}

model CarteEtudiante {
  id              String        @id @default(cuid())
  numeroCarte     String        @unique
  dateExpiration  DateTime
  dateCreation    DateTime      @default(now())
  statut          StatutCarte   @default(ACTIVE)
  includeQRCode   Boolean       @default(true)
  includePhoto    Boolean       @default(true)
  studentId       String
  vagueId         String
  filiereId       Int
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  student         Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  vague           Vague         @relation(fields: [vagueId], references: [id], onDelete: Cascade)
  filiere         Filiere       @relation(fields: [filiereId], references: [id], onDelete: Cascade)
  historiqueCarte HistoriqueCarte[]
  impressionCarte ImpressionCarte[]

  @@map("cartes_etudiantes")
}

model ImpressionCarte {
  id              String   @id @default(cuid())
  carteId         String
  dateImpression  DateTime @default(now())
  imprimePar      String
  typeImpression  TypeImpression
  nombreCopies    Int      @default(1)

  // Relations
  carte           CarteEtudiante @relation(fields: [carteId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [imprimePar], references: [id], onDelete: Cascade)

  @@map("impressions_cartes")
}

model ModeleCarte {
  id              String   @id @default(cuid())
  nom             String
  description     String?
  designConfig    Json
  estActif        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdById     String

  // Relations
  createdBy       User     @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@map("modeles_cartes")
}

model HistoriqueCarte {
  id              String      @id @default(cuid())
  carteId         String
  ancienStatut    StatutCarte
  nouveauStatut   StatutCarte
  raison          String?
  dateChangement  DateTime    @default(now())
  modifiePar      String

  // Relations
  carte           CarteEtudiante @relation(fields: [carteId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [modifiePar], references: [id], onDelete: Cascade)

  @@map("historique_cartes")
}

model ParametresCarte {
  id                      String   @id @default(cuid())
  dureeValiditeMois       Int      @default(12)
  prefixeNumeroCarte      String   @default("CF")
  formatNumeroCarte       String   @default("CF-YYYY-NNN")
  logoParDefaut           String?
  signatureDirecteur      String?
  mentionsLegales         String?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@map("parametres_cartes")
}

model Facture {
  id               String         @id @default(cuid())
  numero           String         @unique
  paiementId       String         @unique
  studentId        String
  typePaiement     String
  methodePaiement  String
  datePaiement     DateTime
  montantTotal     Int
  statut           FactureStatut  @default(generee)
  semester         String?
  notes            String?
  banque           String?
  numeroCheque     String?
  numeroCompte     String?
  operateurMobile  String?
  numeroTelephone  String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Relations
  student          Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  paiement         Paiement       @relation(fields: [paiementId], references: [id], onDelete: Cascade)
  items            FactureItem[]

  @@map("factures")
}

model FactureItem {
  id          String   @id @default(cuid())
  factureId   String
  description String
  quantite    Int      @default(1)
  prixUnitaire Int
  montant     Int

  // Relations
  facture     Facture @relation(fields: [factureId], references: [id], onDelete: Cascade)

  @@map("facture_items")
}

model Operation {
  id        String   @id @default(cuid())
  date      DateTime
  vague     String
  filiere   String
  libelle   String
  debit     Int      @default(0)
  credit    Int      @default(0)
  reference String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  type      String   @default("manuel")
  source    String   @default("manuel") 
  statut    String   @default("comptabilise")
  
  inscriptionId String?
  inscription   Inscription? @relation(fields: [inscriptionId], references: [id])
  
  paiementId    String?
  paiement      Paiement?    @relation(fields: [paiementId], references: [id])

  studentId     String?
  student       Student?     @relation(fields: [studentId], references: [id])

  @@map("operation")
}

// RAPPORT D'ACTIVITÉ (corrigé)
model Bilan {
  id              String        @id @default(cuid())
  titre           String
  type            TypeRapport
  vagueId         String?
  periode         String
  dateGeneration  DateTime      @default(now())
  generePar       String
  statut          StatutRapport @default(GENERE)
  taille          String?
  resume          String?
  inclusions      Json?
  statistiques    Json?
  
  // Relations (corrigées)
  vague           Vague?        @relation("VagueBilan", fields: [vagueId], references: [id])
  user            User          @relation(fields: [generePar], references: [id], onDelete: Cascade)
  
  @@map("bilans")
}

// ENUMS
enum UserRole {
  ADMIN
  CENSEUR
  SECRETAIRE
  COMPTABLE
  ENSEIGNANT
  ETUDIANT
  PARENT
}

enum TypeModule {
  theorique
  pratique
  mixte
  projet
}

enum StatutInscription {
  EN_ATTENTE
  APPROUVE
  REJETE
  PAYE_PARTIEL
  PAYE_COMPLET
  COMPLET
  PAYE
}

enum FraisStatut {
  ACTIF
  ARCHIVE
}

enum TypeFrais {
  INSCRIPTION_UNIVERSEL
  AUTRES_FRAIS
}

enum StatutDossier {
  EN_ATTENTE
  COMPLET
  INCOMPLET
  VALIDE
  REJETE
}

enum StatutCarte {
  ACTIVE
  INACTIVE
  EN_ATTENTE
  EXPIREE
}

enum TypeImpression {
  SIMPLE
  LOT
  RENOUVELLEMENT
}

enum FactureStatut {
  generee
  envoyee
  annulee
  payee
}

enum TypeRapport {
  VAGUE
  MENSUEL
  ANNUEL
  SPECIAL
}

enum StatutRapport {
  EN_COURS
  GENERE
  ERREUR
}
